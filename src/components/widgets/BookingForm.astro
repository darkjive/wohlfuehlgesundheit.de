---
// BookingForm.astro - Comprehensive anamnesis form with Zoom booking
// Component for Stefanie Leidel - Holistic Gut Therapy
// Modularly built with reusable components

import Headline from '~/components/ui/Headline.astro';
import PersonalData from './booking-form/PersonalData.astro';
import PersonalInfo from './booking-form/PersonalInfo.astro';
import HealthQuestions from './booking-form/HealthQuestions.astro';
import MedicalHistory from './booking-form/MedicalHistory.astro';
import NutritionLifestyle from './booking-form/NutritionLifestyle.astro';
import Digestion from './booking-form/Digestion.astro';
import Readiness from './booking-form/Readiness.astro';
import Expectations from './booking-form/Expectations.astro';
import ZoomBooking from './booking-form/ZoomBooking.astro';
import Consent from './booking-form/Consent.astro';
import Emoji from 'astro-emoji';
---

<section class="dark:bg-page csm:py-20 bg-white py-12">
  <Fragment slot="bg">
    <div
      class="dark:bg-dark absolute -z-10 bg-[url(~/assets/images/bg.svg)] bg-auto bg-right dark:bg-none md:bg-[url(~/assets/images/hippokrates-large.jpg)] md:bg-right md:bg-no-repeat"
    >
    </div>
  </Fragment>

  <div class="mx-auto max-w-5xl px-4 sm:px-6">
    <!-- Header -->
    <Headline
      title="Dein Weg zu mehr Darmgesundheit beginnt hier"
      subtitle="F√ºlle den Anamnesebogen sorgf√§ltig aus und buche direkt dein Erstgespr√§ch. So kann ich mir ein umfassendes Bild von deiner gesundheitlichen Situation machen und dich optimal auf unser erstes Gespr√§ch vorbereiten. Alle Angaben werden selbstverst√§ndlich vertraulich behandelt."
      classes={{ container: 'mb-10 max-w-3xl' }}
    />

    <!-- Success Message -->
    <div id="success-message" class="mb-6 hidden rounded-lg bg-green-50 p-8 shadow-md">
      <div class="text-center">
        <p class="mb-4 text-2xl"><Emoji symbol="üíñ üíñ üíñ" label="Heart" /></p>
        <h3 class="mb-4 text-3xl font-bold text-green-800 md:text-4xl">Danke, das hat geklappt!</h3>
        <p class="text-green-600" id="success-text"></p>
      </div>
    </div>

    <!-- Error Message -->
    <div id="error-message" class="mb-6 hidden rounded-lg bg-red-50 p-6 shadow-md">
      <div class="flex items-start">
        <svg class="mt-0.5 h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div class="ml-3">
          <h3 class="text-lg font-semibold text-red-800">Fehler beim Senden</h3>
          <p class="mt-2 text-red-600" id="error-text"></p>
        </div>
      </div>
    </div>

    <!-- Form -->
    <form
      id="booking-form"
      class="space-y-8 rounded-2xl bg-white p-6 shadow-xl dark:bg-primary sm:p-10"
      data-animate="fadeIn"
      data-animate-duration="1000"
    >
      <!-- Personal Data -->
      <div data-animate="fadeIn" data-animate-duration="600" data-animate-delay="100">
        <PersonalData />
      </div>

      <!-- Personal Information -->
      <div data-animate="fadeIn" data-animate-duration="600" data-animate-delay="150">
        <PersonalInfo />
      </div>

      <!-- Health Questions -->
      <div data-animate="fadeIn" data-animate-duration="600" data-animate-delay="200">
        <HealthQuestions />
      </div>

      <!-- Medical History -->
      <div data-animate="fadeIn" data-animate-duration="600" data-animate-delay="250">
        <MedicalHistory />
      </div>

      <!-- Nutrition & Lifestyle -->
      <div data-animate="fadeIn" data-animate-duration="600" data-animate-delay="300">
        <NutritionLifestyle />
      </div>

      <!-- Digestion & Bowel Movements -->
      <div data-animate="fadeIn" data-animate-duration="600" data-animate-delay="350">
        <Digestion />
      </div>

      <!-- Readiness -->
      <div data-animate="fadeIn" data-animate-duration="600" data-animate-delay="400">
        <Readiness />
      </div>

      <!-- Expectations and Origin -->
      <div data-animate="fadeIn" data-animate-duration="600" data-animate-delay="450">
        <Expectations />
      </div>

      <!-- Zoom Appointment Booking -->
      <div data-animate="fadeIn" data-animate-duration="600" data-animate-delay="500">
        <ZoomBooking />
      </div>

      <!-- Consent Declaration -->
      <div data-animate="fadeIn" data-animate-duration="600" data-animate-delay="550">
        <Consent />
      </div>

      <!-- Submit Button -->
      <div class="pt-4" data-animate="fadeIn" data-animate-duration="600" data-animate-delay="600">
        <button type="submit" id="submit-button" class="btn-primary dark:btn-secondary w-full sm:mb-0">
          <span id="button-text">Jetzt Anamnesebogen absenden & Termin buchen</span>
          <span id="button-spinner" class="hidden">
            <svg class="inline h-5 w-5 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
            Wird gesendet...
          </span>
        </button>
        <p class="mt-3 text-center text-base text-gray-300">
          <span class="text-base text-red-600">*</span> Pflichtfelder
        </p>
      </div>
    </form>
  </div>
</section>

<script>
  import {
    setupFormValidation,
    validateFormOnSubmit,
    ValidationPatterns,
    type ValidationRules,
  } from '~/utils/form-validation';

  // Set minimum date to tomorrow
  const datumInput = document.getElementById('datum') as HTMLInputElement;
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const minDate = tomorrow.toISOString().split('T')[0];
  datumInput.setAttribute('min', minDate);

  // Form submission handler
  const form = document.getElementById('booking-form') as HTMLFormElement;
  const submitButton = document.getElementById('submit-button') as HTMLButtonElement;
  const buttonText = document.getElementById('button-text') as HTMLSpanElement;
  const buttonSpinner = document.getElementById('button-spinner') as HTMLSpanElement;
  const successMessage = document.getElementById('success-message') as HTMLDivElement;
  const errorMessage = document.getElementById('error-message') as HTMLDivElement;
  const successText = document.getElementById('success-text') as HTMLParagraphElement;
  const errorText = document.getElementById('error-text') as HTMLParagraphElement;

  // Define comprehensive validation rules for anamnese form
  const validationRules: ValidationRules = {
    // Personal Data (required fields)
    vorname: [
      { required: true, message: 'Bitte gib deinen Vornamen ein.' },
      { minLength: 2, message: 'Der Vorname muss mindestens 2 Zeichen lang sein.' },
    ],
    nachname: [
      { required: true, message: 'Bitte gib deinen Nachnamen ein.' },
      { minLength: 2, message: 'Der Nachname muss mindestens 2 Zeichen lang sein.' },
    ],
    // Adresse, PLZ, Ort sind optional (Datenschutz)
    plz: [{ pattern: ValidationPatterns.germanZip, message: 'Bitte gib eine g√ºltige 5-stellige PLZ ein.' }],
    telefon: [
      { required: true, message: 'Bitte gib deine Telefonnummer ein.' },
      { pattern: ValidationPatterns.phone, message: 'Bitte gib eine g√ºltige Telefonnummer ein.' },
      { minLength: 6, message: 'Die Telefonnummer muss mindestens 6 Zeichen lang sein.' },
    ],
    email: [
      { required: true, message: 'Bitte gib deine E-Mail-Adresse ein.' },
      { pattern: ValidationPatterns.email, message: 'Bitte gib eine g√ºltige E-Mail-Adresse ein.' },
    ],

    // Personal Info (optional but validated if filled)
    alter: [
      { min: 1, message: 'Das Alter muss mindestens 1 sein.' },
      { max: 150, message: 'Bitte gib ein realistisches Alter ein.' },
    ],
    groesse: [
      { min: 50, message: 'Die Gr√∂√üe muss mindestens 50 cm sein.' },
      { max: 250, message: 'Bitte gib eine realistische Gr√∂√üe ein.' },
    ],
    gewicht: [
      { min: 10, message: 'Das Gewicht muss mindestens 10 kg sein.' },
      { max: 500, message: 'Bitte gib ein realistisches Gewicht ein.' },
    ],

    // Zoom Booking (required fields)
    datum: [{ required: true, message: 'Bitte w√§hle ein Datum f√ºr den Termin.' }],
    uhrzeit: [{ required: true, message: 'Bitte w√§hle eine Uhrzeit f√ºr den Termin.' }],
    dauer: [{ required: true, message: 'Bitte w√§hle eine Gespr√§chsdauer.' }],

    // Consent (required)
    datenschutz: [{ required: true, message: 'Bitte akzeptiere die Datenschutzerkl√§rung.' }],
  };

  // Setup real-time validation
  setupFormValidation(form, validationRules, {
    validateOnBlur: true,
    validateOnInput: true,
    showValidIndicator: true,
  });

  // Load CSRF token on page load
  let csrfToken = '';

  async function loadCSRFToken(): Promise<string> {
    try {
      const response = await fetch('/api/get-csrf-token.php');
      const data = await response.json();
      if (data.success && data.token) {
        return data.token;
      } else {
        console.error('Failed to load CSRF token');
        return '';
      }
    } catch (error) {
      console.error('Error loading CSRF token:', error);
      return '';
    }
  }

  // Load token when page loads
  loadCSRFToken().then((token) => (csrfToken = token));

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Validate form before submission
    const validationResult = validateFormOnSubmit(form, validationRules);
    if (!validationResult.isValid) {
      return;
    }

    // Hide previous messages
    successMessage.classList.add('hidden');
    errorMessage.classList.add('hidden');

    // Disable button and show spinner
    submitButton.disabled = true;
    buttonText.classList.add('hidden');
    buttonSpinner.classList.remove('hidden');

    // Collect form data
    const formData = new FormData(form);

    // Add CSRF token - reload if not available
    if (!csrfToken) {
      csrfToken = await loadCSRFToken();
    }

    if (csrfToken) {
      formData.append('csrf_token', csrfToken);
    } else {
      errorText.textContent = 'Sicherheitstoken konnte nicht geladen werden. Bitte lade die Seite neu.';
      errorMessage.classList.remove('hidden');
      return;
    }

    try {
      const response = await fetch('/api/anamnese-booking.php', {
        method: 'POST',
        body: formData,
      });

      const result = await response.json();

      if (result.success) {
        // Show success message
        successText.textContent = result.message || 'Vielen Dank! Dein Anamnesebogen wurde erfolgreich √ºbermittelt.';
        successMessage.classList.remove('hidden');

        // Reset form
        form.reset();

        // Reload CSRF token for next submission
        loadCSRFToken().then((token) => (csrfToken = token));

        // Scroll to success message
        successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } else {
        // Show error message
        errorText.textContent = result.message || 'Ein Fehler ist aufgetreten. Bitte versuche es sp√§ter erneut.';
        errorMessage.classList.remove('hidden');

        // Reload CSRF token
        loadCSRFToken().then((token) => (csrfToken = token));

        // Scroll to error message
        errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    } catch (error) {
      // Show error message
      errorText.textContent = 'Verbindungsfehler. Bitte √ºberpr√ºfe deine Internetverbindung und versuche es erneut.';
      errorMessage.classList.remove('hidden');
      errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });

      console.error('Form submission error:', error);
    } finally {
      // Re-enable button and hide spinner
      submitButton.disabled = false;
      buttonText.classList.remove('hidden');
      buttonSpinner.classList.add('hidden');
    }
  });
</script>
