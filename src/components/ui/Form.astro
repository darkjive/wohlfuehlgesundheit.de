---
import type { Form as Props } from '~/types';
import Button from '~/components/ui/Button.astro';
import Emoji from 'astro-emoji';
const { inputs, textarea, disclaimer, button = 'Absenden', description = '' } = Astro.props;
---

<!-- Success Message -->
<div id="contact-success-message" class="mb-6 hidden rounded-lg bg-green-50 p-8 shadow-md">
  <div class="text-center">
    <p class="mb-4 text-2xl"><Emoji symbol="üíñ üíñ üíñ" label="Heart" /></p>
    <h3 class="mb-4 text-3xl font-bold text-green-800 md:text-4xl">Danke, das hat geklappt!</h3>
    <p class="text-green-700" id="contact-success-text"></p>
  </div>
</div>

<!-- Error Message -->
<div id="contact-error-message" class="mb-6 hidden rounded-lg bg-red-50 p-6 shadow-md">
  <div class="flex items-start">
    <svg class="mt-0.5 h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <div class="ml-3">
      <h3 class="text-lg font-semibold text-red-800">Fehler beim Senden</h3>
      <p class="mt-2 text-red-700" id="contact-error-text"></p>
    </div>
  </div>
</div>

<form id="contact-form" method="POST">
  <!-- Required: SPAM Protection -->
  <input type="checkbox" name="botcheck" class="hidden" style="display: none;" />

  {
    inputs &&
      inputs.map(
        ({ type = 'text', name, label = '', autocomplete = 'on', placeholder = '' }, index) =>
          name && (
            <div class="mb-6" data-animate="fadeIn" data-animate-duration="600" data-animate-delay={index * 100}>
              {label && (
                <label for={name} class="mb-3 block text-base font-medium">
                  {label}
                  {type === 'email' && <span class="text-base text-red-500">*</span>}
                </label>
              )}
              <input
                type={type}
                name={name}
                id={name}
                autocomplete={autocomplete}
                placeholder={placeholder}
                class="text-md dark:bg-dark block w-full rounded-lg border border-gray-200 bg-white px-4 py-3 dark:border-none"
                required={type === 'email' ? true : undefined}
              />
            </div>
          )
      )
  }

  {
    textarea && (
      <div data-animate="fadeIn" data-animate-duration="600" data-animate-delay={(inputs?.length || 0) * 100}>
        <label for="textarea" class="mb-3 block text-base font-medium">
          {textarea.label} <span class="text-base text-red-500">*</span>
        </label>
        <textarea
          id="textarea"
          name={textarea.name ? textarea.name : 'message'}
          rows={textarea.rows ? textarea.rows : 4}
          placeholder={textarea.placeholder}
          class="text-md dark:bg-dark block w-full rounded-lg border border-gray-200 bg-white px-4 py-3 dark:border-none"
          required
        />
      </div>
    )
  }

  {
    disclaimer && (
      <div
        class="mt-3 flex items-start"
        data-animate="fadeIn"
        data-animate-duration="600"
        data-animate-delay={(inputs?.length || 0) * 100 + 100}
      >
        <div class="mt-0.5 flex">
          <input
            id="disclaimer"
            name="disclaimer"
            type="checkbox"
            class="mt-1 block cursor-pointer rounded-lg border border-gray-200 bg-white p-8 text-2xl dark:border-none dark:bg-slate-900"
            required
          />
        </div>
        <div class="ml-3">
          <label for="disclaimer" class="text-md cursor-pointer select-none text-gray-600 dark:text-white">
            {disclaimer.label}
          </label>
        </div>
      </div>
    )
  }

  {
    button && (
      <div
        class="mt-10 grid"
        data-animate="fadeIn"
        data-animate-duration="600"
        data-animate-delay={(inputs?.length || 0) * 100 + 200}
      >
        <Button variant="primary" type="submit" id="contact-submit-button">
          <span id="contact-button-text">{button}</span>
          <span id="contact-button-spinner" class="hidden">
            <svg class="inline h-5 w-5 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              />
            </svg>
            Wird gesendet...
          </span>
        </Button>
        <p class="mt-3 text-center text-base text-gray-300">
          <span class="text-base text-red-500">*</span> Pflichtfelder
        </p>
      </div>
    )
  }

  {
    description && (
      <div class="mt-3 text-center">
        <p class="text-base text-gray-600 dark:text-white">{description}</p>
      </div>
    )
  }
</form>

<script>
  import {
    setupFormValidation,
    validateFormOnSubmit,
    ValidationPatterns,
    type ValidationRules,
  } from '~/utils/form-validation';

  // Contact Form Handler with CSRF Protection and Caching
  (function () {
    const contactForm = document.getElementById('contact-form') as HTMLFormElement | null;
    const submitButton = document.getElementById('contact-submit-button') as HTMLButtonElement | null;
    const buttonText = document.getElementById('contact-button-text') as HTMLSpanElement | null;
    const buttonSpinner = document.getElementById('contact-button-spinner') as HTMLSpanElement | null;
    const successMessage = document.getElementById('contact-success-message') as HTMLDivElement | null;
    const errorMessage = document.getElementById('contact-error-message') as HTMLDivElement | null;
    const successText = document.getElementById('contact-success-text') as HTMLParagraphElement | null;
    const errorText = document.getElementById('contact-error-text') as HTMLParagraphElement | null;

    // Early exit if required elements are missing
    if (
      !contactForm ||
      !submitButton ||
      !buttonText ||
      !buttonSpinner ||
      !successMessage ||
      !errorMessage ||
      !successText ||
      !errorText
    ) {
      console.error('Contact form: Required DOM elements not found');
      return;
    }

    // Define validation rules
    const validationRules: ValidationRules = {
      name: [
        { required: true, message: 'Bitte gib deinen Namen ein.' },
        { minLength: 2, message: 'Der Name muss mindestens 2 Zeichen lang sein.' },
      ],
      email: [
        { required: true, message: 'Bitte gib deine E-Mail-Adresse ein.' },
        { pattern: ValidationPatterns.email, message: 'Bitte gib eine g√ºltige E-Mail-Adresse ein.' },
      ],
      message: [
        { required: true, message: 'Bitte gib deine Nachricht ein.' },
        { minLength: 10, message: 'Die Nachricht muss mindestens 10 Zeichen lang sein.' },
      ],
      disclaimer: [{ required: true, message: 'Bitte akzeptiere die Datenschutzerkl√§rung.' }],
    };

    // Setup real-time validation
    setupFormValidation(contactForm, validationRules, {
      validateOnBlur: true,
      validateOnInput: true,
      showValidIndicator: true,
    });

    // Load CSRF token on page load
    let csrfToken = '';

    async function loadCSRFToken() {
      try {
        const response = await fetch('/api/get-csrf-token.php');
        const data = await response.json();
        if (data.success && data.token) {
          csrfToken = data.token;
        } else {
          console.error('Failed to load CSRF token');
        }
      } catch (error) {
        console.error('Error loading CSRF token:', error);
      }
    }

    // Load token when page loads
    loadCSRFToken();

    contactForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Validate form before submission
      const validationResult = validateFormOnSubmit(contactForm, validationRules);
      if (!validationResult.isValid) {
        return;
      }

      // Hide previous messages
      successMessage.classList.add('hidden');
      errorMessage.classList.add('hidden');

      // Disable button and show spinner
      submitButton.disabled = true;
      buttonText.classList.add('hidden');
      buttonSpinner.classList.remove('hidden');

      // Collect form data
      const formData = new FormData(contactForm);

      // Add CSRF token
      if (csrfToken) {
        formData.append('csrf_token', csrfToken);
      } else {
        // Try to reload token if not available
        await loadCSRFToken();
        if (csrfToken) {
          formData.append('csrf_token', csrfToken);
        }
      }

      try {
        const response = await fetch('/api/contact-form.php', {
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          // Show success message
          successText.textContent = result.message || 'Vielen Dank f√ºr deine Nachricht!';
          successMessage.classList.remove('hidden');

          // Reset form
          contactForm.reset();

          // Reload CSRF token for next submission
          loadCSRFToken();

          // Scroll to success message
          successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
          // Show error message
          errorText.textContent = result.message || 'Ein Fehler ist aufgetreten. Bitte versuche es sp√§ter erneut.';
          errorMessage.classList.remove('hidden');

          // Reload CSRF token
          loadCSRFToken();

          // Scroll to error message
          errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      } catch (error) {
        // Show error message
        errorText.textContent = 'Verbindungsfehler. Bitte √ºberpr√ºfe deine Internetverbindung und versuche es erneut.';
        errorMessage.classList.remove('hidden');
        errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });

        console.error('Form submission error:', error);
      } finally {
        // Re-enable button and hide spinner
        submitButton.disabled = false;
        buttonText.classList.remove('hidden');
        buttonSpinner.classList.add('hidden');
      }
    });
  })();
</script>
