---
import { Icon } from 'astro-icon/components';
import { getPermalink } from '~/utils/permalinks';

interface Link {
  text?: string;
  href?: string;
  ariaLabel?: string;
  icon?: string;
}

interface FooterSection {
  title: string;
  links: Array<Link>;
}

export interface Props {
  sections?: Array<FooterSection>;
  secondaryLinks?: Array<Link>;
  socialLinks?: Array<Link>;
  footNote?: string;
  theme?: string;
}

const { sections = [], secondaryLinks = [], socialLinks = [], footNote = '', theme = 'light' } = Astro.props;

const buildTime = import.meta.env.BUILD_TIME || '';
const formattedBuildTime = buildTime
  ? new Date(buildTime).toLocaleString('de-DE', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
    })
  : '';

// Default sections if none provided
const footerSections: FooterSection[] = sections.length > 0 ? sections : [
  {
    title: 'Navigation',
    links: [
      { text: 'Start', href: getPermalink() },
      { text: 'Über mich', href: getPermalink('/ueber-mich') },
      { text: 'Termin buchen', href: getPermalink('/termin-buchen') },
      { text: 'Kontakt', href: getPermalink('/kontakt') },
    ],
  },
  {
    title: 'Rechtliches',
    links: secondaryLinks,
  },
];
---

<footer class:list={[{ dark: theme === 'dark' }, 'not-prose relative border-t border-gray-200 dark:border-gray-700']}>
  <div class="pointer-events-none absolute inset-0 dark:bg-none" aria-hidden="true"></div>
  <div class="relative mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">
    <!-- Main footer content -->
    <div class="grid grid-cols-1 gap-8 md:grid-cols-2 lg:grid-cols-4">
      <!-- Brand section -->
      <div class="space-y-4">
        <h3 class="font-heading text-xl font-bold text-primary dark:text-secondary">Wohlfühlgesundheit</h3>
        <p class="text-sm text-gray-600 dark:text-gray-300">
          Holistische Darmtherapie für dein Wohlbefinden
        </p>
      </div>

      <!-- Dynamic sections (collapsed on mobile) -->
      {
        footerSections.map((section, index) => (
          <div class="space-y-4">
            <button
              type="button"
              class="footer-toggle flex w-full items-center justify-between font-heading text-lg font-semibold text-gray-900 dark:text-gray-100 md:pointer-events-none"
              aria-expanded="false"
              data-section={`footer-section-${index}`}
            >
              {section.title}
              <Icon name="tabler:chevron-down" class="h-5 w-5 transition-transform md:hidden" />
            </button>
            <div
              id={`footer-section-${index}`}
              class="footer-content hidden space-y-2 md:block"
            >
              {section.links.map((link) => (
                <a
                  href={link.href}
                  class="block text-sm text-gray-600 transition-colors hover:text-primary dark:text-gray-300 dark:hover:text-secondary"
                >
                  {link.text}
                </a>
              ))}
            </div>
          </div>
        ))
      }

      <!-- Social Media section -->
      {
        socialLinks.length > 0 && (
          <div class="space-y-4">
            <button
              type="button"
              class="footer-toggle flex w-full items-center justify-between font-heading text-lg font-semibold text-gray-900 dark:text-gray-100 md:pointer-events-none"
              aria-expanded="false"
              data-section="footer-social"
            >
              Social Media
              <Icon name="tabler:chevron-down" class="h-5 w-5 transition-transform md:hidden" />
            </button>
            <div id="footer-social" class="footer-content hidden space-y-3 md:block">
              {socialLinks.map(({ ariaLabel, href, text, icon }) => (
                <a
                  href={href}
                  aria-label={ariaLabel}
                  class="flex items-center gap-2 text-sm text-gray-600 transition-colors hover:text-primary dark:text-gray-300 dark:hover:text-secondary"
                >
                  {icon && <Icon name={icon} class="h-5 w-5" />}
                  <span>{text}</span>
                </a>
              ))}
            </div>
          </div>
        )
      }
    </div>

    <!-- Bottom section -->
    <div class="mt-12 border-t border-gray-200 pt-8 dark:border-gray-700">
      <div class="text-center text-sm text-gray-600 dark:text-gray-300">
        {footNote ? <Fragment set:html={footNote} /> : <p>© {new Date().getFullYear()} Wohlfühlgesundheit - Holistische Darmtherapie</p>}
      </div>
      {
        formattedBuildTime && (
          <div
            class="mt-2 text-center text-xs text-gray-500 opacity-50 dark:text-gray-400"
            title={`Build: ${buildTime}`}
          >
            {formattedBuildTime}
          </div>
        )
      }
    </div>
  </div>
</footer>

<script>
  // Simple accordion functionality for mobile
  function initFooterToggles() {
    const toggles = document.querySelectorAll('.footer-toggle');

    toggles.forEach((toggle) => {
      toggle.addEventListener('click', () => {
        // Only work on mobile
        if (window.innerWidth >= 768) return;

        const sectionId = toggle.getAttribute('data-section');
        const content = document.getElementById(sectionId);
        const icon = toggle.querySelector('svg');

        if (!content) return;

        const isExpanded = toggle.getAttribute('aria-expanded') === 'true';

        // Toggle visibility
        toggle.setAttribute('aria-expanded', String(!isExpanded));
        content.classList.toggle('hidden');

        // Rotate icon
        if (icon) {
          icon.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
        }
      });
    });
  }

  // Initialize on page load
  initFooterToggles();

  // Re-initialize after view transitions
  document.addEventListener('astro:page-load', initFooterToggles);
</script>
